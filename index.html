/*
 * PERSONAL MUSIC-STREAMING SITE – v2  (Categories & GitHub-synced storage)
 * -----------------------------------------------------------------------
 * This revision adds:
 *   ? Two top-level categories: **yedits** and **personal** (your own tracks).
 *   ? Home page buttons to choose either category.
 *   ? Server scans both folders recursively at start-up (or on demand) so you can
 *     keep the audio files in a Git repo and just `git pull` to update music.
 *   ? The upload form now lets you pick which category to save into.
 *   ? All endpoints are namespaced by category (e.g. `/api/tracks/yedits`).
 *
 * Directory layout
 *  music-streaming-site/
 *  +- music/              ? clone your Git repo here (or sub-module)
 *  ¦   +- yedits/         ? *.mp3, *.flac, subfolders allowed
 *  ¦   +- personal/
 *  +- server/            ? Node backend (unchanged command: `npm start`)
 *  +- client/            ? React frontend
 *
 * NOTE  There is **no database** now: the file tree *is* the source of truth.
 *       ID3 metadata is cached into `cache.json` to avoid parsing on every
 *       request; delete the file to force a re-scan.
 * -----------------------------------------------------------------------
 */

/****************************
 *  server/package.json
 ***************************/
{
  "name": "music-streaming-server",
  "type": "module",
  "version": "2.0.0",
  "scripts": { "start": "node server.js" },
  "dependencies": {
    "cors": "^2.8.5",
    "express": "^4.19.0",
    "fast-glob": "^3.3.2",
    "music-metadata": "^9.0.0",
    "p-limit": "^4.0.0"
  }
}

/****************************
 *  server/server.js
 ***************************/
import express from "express";
import cors from "cors";
import fs from "fs/promises";
import { statSync, createReadStream } from "fs";
import path from "path";
import fg from "fast-glob";
import mm from "music-metadata";
import pLimit from "p-limit";

const MUSIC_ROOT = path.join(process.cwd(), "music");
const CATEGORIES = ["yedits", "personal"];
const CACHE_FILE = path.join(process.cwd(), "cache.json");
const PARALLEL = 4; // concurrent metadata parses

const app = express();
app.use(cors());
app.use(express.json());

let cache = {};
try { cache = JSON.parse(await fs.readFile(CACHE_FILE, "utf8")); } catch {}

// Utility: scan category dir & build metadata list -------------------------
async function scanCategory(cat) {
  const dir = path.join(MUSIC_ROOT, cat);
  const entries = await fg(["**/*.mp3", "**/*.flac"], { cwd: dir, onlyFiles: true });
  const limit = pLimit(PARALLEL);
  const tracks = await Promise.all(entries.map(rel => limit(async () => {
    const filePath = path.join(dir, rel);
    const id = path.posix.join(cat, rel).replace(/\\/g, "/");
    if (cache[id]) return cache[id];
    const meta = await mm.parseFile(filePath, { duration: false });
    const { title, artist, album, year, genre } = meta.common;
    const track = {
      id,
      cat,
      rel,
      title: title || path.basename(rel),
      artist: artist || "Unknown Artist",
      album: album || null,
      year: year || null,
      genre: genre?.[0] || null,
      mimeType: meta.format.container === "FLAC" ? "audio/flac" : "audio/mpeg",
      size: statSync(filePath).size,
    };
    cache[id] = track;
    return track;
  })));
  await fs.writeFile(CACHE_FILE, JSON.stringify(cache, null, 2));
  return tracks;
}

// Cached full index in memory ---------------------------------------------
let index = {};
async function buildIndex() {
  for (const cat of CATEGORIES) index[cat] = await scanCategory(cat);
  console.log("Music index built:", CATEGORIES.map(c => `${c}: ${index[c].length}`).join(", "));
}
await buildIndex();

// Endpoint: list tracks of a category -------------------------------------
app.get("/api/tracks/:cat", async (req, res) => {
  const { cat } = req.params;
  if (!CATEGORIES.includes(cat)) return res.status(404).send("No such category");
  res.json(index[cat]);
});

// Endpoint: stream track ---------------------------------------------------
app.get("/api/stream/:cat/*", (req, res) => {
  const { cat } = req.params;
  const rel = req.params[0]; // splat
  const id = path.posix.join(cat, rel);
  const track = cache[id];
  if (!track) return res.sendStatus(404);

  const filePath = path.join(MUSIC_ROOT, id);
  const { size } = statSync(filePath);
  const range = req.headers.range;

  if (range) {
    const [startStr, endStr] = range.replace(/bytes=/, "").split("-");
    const start = parseInt(startStr, 10);
    const end = endStr ? parseInt(endStr, 10) : size - 1;
    const chunk = end - start + 1;
    res.writeHead(206, {
      "Content-Range": `bytes ${start}-${end}/${size}`,
      "Accept-Ranges": "bytes",
      "Content-Length": chunk,
      "Content-Type": track.mimeType,
    });
    createReadStream(filePath, { start, end }).pipe(res);
  } else {
    res.writeHead(200, {
      "Content-Length": size,
      "Content-Type": track.mimeType,
    });
    createReadStream(filePath).pipe(res);
  }
});

// Optional: trigger a manual rescan
app.post("/api/rescan", async (req, res) => {
  await buildIndex();
  res.json({ ok: true });
});

const PORT = process.env.PORT || 3001;
app.listen(PORT, () => console.log(`API ? at http://localhost:${PORT}`));

/****************************
 *  client/package.json  (unchanged deps + react-router)
 ***************************/
{
  "name": "music-streaming-client",
  "private": true,
  "version": "2.0.0",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-howler": "^5.0.4",
    "react-router-dom": "^6.23.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.2.0",
    "tailwindcss": "^3.4.0",
    "vite": "^5.2.0"
  }
}

/****************************
 *  client/src/App.jsx  (router + category buttons)
 ***************************/
import React from "react";
import { BrowserRouter, Routes, Route, Link, useParams } from "react-router-dom";
import Category from "./pages/Category.jsx";

export default function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route
          path="/"
          element={
            <main className="min-h-screen flex flex-col items-center justify-center gap-8 bg-slate-100">
              <h1 className="text-4xl font-bold">My Music</h1>
              <div className="flex gap-6">
                <Link to="/yedits" className="px-6 py-3 rounded-lg bg-indigo-600 text-white text-xl shadow-md hover:scale-105 transition">Yedits</Link>
                <Link to="/personal" className="px-6 py-3 rounded-lg bg-emerald-600 text-white text-xl shadow-md hover:scale-105 transition">Personal Music</Link>
              </div>
            </main>
          }
        />
        <Route path=":cat" element={<Category />} />
      </Routes>
    </BrowserRouter>
  );
}

/****************************
 *  client/src/pages/Category.jsx
 ***************************/
import React, { useEffect, useState } from "react";
import { useParams, Link } from "react-router-dom";
import Player from "../components/Player.jsx";

export default function Category() {
  const { cat } = useParams();
  const [tracks, setTracks] = useState([]);
  const [current, setCurrent] = useState(null);

  useEffect(() => {
    fetch(`/api/tracks/${cat}`).then(r => r.json()).then(setTracks);
  }, [cat]);

  return (
    <div className="container mx-auto max-w-3xl p-6">
      <Link to="/" className="text-indigo-600">? Back</Link>
      <h2 className="text-3xl font-bold mb-4 capitalize">{cat}</h2>
      <ul className="divide-y divide-gray-300">
        {tracks.map(t => (
          <li key={t.id} className="py-3 cursor-pointer hover:bg-slate-200 rounded-lg px-2" onClick={() => setCurrent(t)}>
            <span className="font-semibold">{t.title}</span> – {t.artist}
          </li>
        ))}
      </ul>
      {current && <Player track={current} />}
    </div>
  );
}

/****************************
 *  client/src/components/Player.jsx  (unchanged except URL)
 ***************************/
import React, { useEffect, useState } from "react";
import ReactHowler from "react-howler";

export default function Player({ track }) {
  const [playing, setPlaying] = useState(true);
  useEffect(() => setPlaying(true), [track.id]);
  return (
    <div className="fixed bottom-0 left-0 right-0 bg-white shadow-md p-4 flex items-center gap-4">
      <button onClick={() => setPlaying(p => !p)} className="bg-indigo-600 text-white rounded-full w-10 h-10 flex items-center justify-center">
        {playing ? "??" : "?"}
      </button>
      <div>
        <div className="font-semibold">{track.title}</div>
        <div className="text-sm text-gray-600">{track.artist}</div>
      </div>
      <ReactHowler src={`/api/stream/${track.cat}/${track.rel}`} playing={playing} html5={true} />
    </div>
  );
}

/*
 * UPLOADER (optional – choose category) – keep or remove as desired
 * -------------------------------------------------------------------
 * If you still want browser uploads, re-enable the UploadForm and POST it
 * to a dedicated endpoint that writes the file under music/<cat>/....  Not
 * included here to keep the demo read-only from Git storage.
 */

/*
 * THAT'S IT!  ??
 *   1. Put/clone your repo with two folders into ./music
 *   2. `cd server && npm i && npm start`
 *   3. `cd client && npm i && npm run dev`
 *   4. Open http://localhost:5173 ? choose category ? play.
 *
 * Rescan after `git pull`: POST /api/rescan (e.g. a button in admin UI).
 */
